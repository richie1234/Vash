(function(a){function d(a){if(typeof a!="string")throw this.exceptionFactory(new Error,"INVALIDINPUT",a);this.lex=new b(a),this.tks=b.tks,this.blockStack=new c,this.mode=d.modes.MKP,this.buffer="",this.buffers=[],this.escape=!0,this.debug=!1,this.consumedTokens=[]}function c(){this._stack=[]}function b(a){this.tokens=[],this.input=this.originalInput=a.replace(/\r\n|\r/g,"\n"),this.deferredTokens=[],this.stash=[],this.lineno=1,this.charno=0}"use strict",a.version="0.3.1-386",a.config={useWith:!1,modelName:"model"},b.prototype={tok:function(a,b){return{type:a,line:this.lineno,chr:this.charno,val:b,touched:0}},scan:function(a,b){var c,d;if(c=a.exec(this.input)){this.consume(c[0].length),d=this.tok(b,c[1]),this.charno+=c[0].length;return d}},spew:function(a){this.input=a+this.input,this.charno-=a.length},consume:function(a){this.input=this.input.substr(a)},spewIf:function(a,b){var c;a&&(a.touched+=1,c=a.val.split(b),c.length>1&&(a.val=c.shift(),a.touched+=1,this.spew(b+c.join(b))));return a},advance:function(){return this.deferred()||this.stashed()||this.next()},defer:function(a){a.touched+=1,this.deferredTokens.push(a)},lookahead:function(a){var b=a-this.stash.length;while(b-->0)this.stash.push(this.next());return this.stash[--a]},next:function(){return this.EMAIL()||this.AT_STAR_OPEN()||this.AT_STAR_CLOSE()||this.AT_BANG()||this.AT_COLON()||this.AT()||this.PAREN_OPEN()||this.PAREN_CLOSE()||this.HARD_PAREN_OPEN()||this.HARD_PAREN_CLOSE()||this.BRACE_OPEN()||this.BRACE_CLOSE()||this.TEXT_TAG_OPEN()||this.TEXT_TAG_CLOSE()||this.HTML_TAG_SELFCLOSE()||this.HTML_TAG_OPEN()||this.HTML_TAG_CLOSE()||this.PERIOD()||this.NEWLINE()||this.WHITESPACE()||this.KEYWORD()||this.IDENTIFIER()||this.CONTENT()},deferred:function(){var a=this.deferredTokens.shift();if(a){a.touched+=1;return a}return!1},stashed:function(){var a=this.stash.shift();if(a){a.touched+=1;return a}return!1},AT:function(){return this.scan(/^(@)/,b.tks.AT)},AT_COLON:function(){return this.scan(/^@\:/,b.tks.AT_COLON)},AT_BANG:function(){return this.scan(/^@\!/,b.tks.AT_BANG)},AT_STAR_OPEN:function(){return this.scan(/^(@\*)/,b.tks.AT_STAR_OPEN)},AT_STAR_CLOSE:function(){return this.scan(/^(\*@)/,b.tks.AT_STAR_CLOSE)},PAREN_OPEN:function(){return this.scan(/^(\()/,b.tks.PAREN_OPEN)},PAREN_CLOSE:function(){return this.scan(/^(\))/,b.tks.PAREN_CLOSE)},BRACE_OPEN:function(){return this.scan(/^(\{)/,b.tks.BRACE_OPEN)},BRACE_CLOSE:function(){return this.scan(/^(\})/,b.tks.BRACE_CLOSE)},HARD_PAREN_OPEN:function(){return this.scan(/^(\[)/,b.tks.HARD_PAREN_OPEN)},HARD_PAREN_CLOSE:function(){return this.scan(/^(\])/,b.tks.HARD_PAREN_CLOSE)},TEXT_TAG_OPEN:function(){return this.scan(/^(<text>)/,b.tks.TEXT_TAG_OPEN)},TEXT_TAG_CLOSE:function(){return this.scan(/^(<\/text>)/,b.tks.TEXT_TAG_CLOSE)},HTML_TAG_SELFCLOSE:function(){return this.spewIf(this.scan(/^(<[^>]+?\/>)/,b.tks.HTML_TAG_SELFCLOSE),"@")},HTML_TAG_OPEN:function(){return this.spewIf(this.scan(/^(<[^\/ >]+?[^>]*?>)/,b.tks.HTML_TAG_OPEN),"@")},HTML_TAG_CLOSE:function(){return this.spewIf(this.scan(/^(<\/[^>\b]+?>)/,b.tks.HTML_TAG_CLOSE),"@")},FUNCTION:function(){return this.scan(/^(function)(?![\d\w])/,b.tks.FUNCTION)},KEYWORD:function(){return this.scan(/^(case|catch|do|else|finally|for|function|goto|if|instanceof|return|switch|try|typeof|var|while|with)(?![\d\w])/,b.tks.KEYWORD)},IDENTIFIER:function(){return this.scan(/^([_$a-zA-Z\xA0-\uFFFF][_$a-zA-Z0-9\xA0-\uFFFF]*)/,b.tks.IDENTIFIER)},PERIOD:function(){return this.scan(/^(\.)/,b.tks.PERIOD)},EMAIL:function(){return this.scan(/^([a-zA-Z0-9._%-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4})\b/,b.tks.EMAIL)},CONTENT:function(){return this.scan(/^([^\s})@.]+?)/,b.tks.CONTENT)},WHITESPACE:function(){return this.scan(/^(\s)/,b.tks.WHITESPACE)},NEWLINE:function(){var a=this.scan(/^(\n)/,b.tks.NEWLINE);a&&(this.lineno++,this.charno=0);return a}},b.tks={AT:"AT",AT_STAR_OPEN:"AT_STAR_OPEN",AT_STAR_CLOSE:"AT_STAR_CLOSE",AT_COLON:"AT_COLON",AT_BANG:"AT_BANG",EMAIL:"EMAIL",PAREN_OPEN:"PAREN_OPEN",PAREN_CLOSE:"PAREN_CLOSE",BRACE_OPEN:"BRACE_OPEN",BRACE_CLOSE:"BRACE_CLOSE",HARD_PAREN_OPEN:"HARD_PAREN_OPEN",HARD_PAREN_CLOSE:"HARD_PAREN_CLOSE",TEXT_TAG_OPEN:"TEXT_TAG_OPEN",TEXT_TAG_CLOSE:"TEXT_TAG_CLOSE",HTML_TAG_SELFCLOSE:"HTML_TAG_SELFCLOSE",HTML_TAG_OPEN:"HTML_TAG_OPEN",HTML_TAG_CLOSE:"HTML_TAG_CLOSE",KEYWORD:"KEYWORD",FUNCTION:"FUNCTION",IDENTIFIER:"IDENTIFIER",PERIOD:"PERIOD",CONTENT:"CONTENT",WHITESPACE:"WHITESPACE",NEWLINE:"NEWLINE"},c.prototype={push:function(a){this._stack.push(a);return this},pop:function(){return this._stack.length>0?this._stack.pop():null},peek:function(){return this._stack.length>0?this._stack[this._stack.length-1]:null},count:function(){return this._stack.length},raw:function(){return this._stack}},d.modes={MKP:"MARKUP",BLK:"BLOCK",EXP:"EXPRESSION"},d.prototype={parse:function(){var a,b,c,e,f;while(a=this.lex.advance()){this.debug&&console.debug(this.mode,a.type,a,a.val);if(this.mode===d.modes.MKP){this._handleMKP(a);continue}if(this.mode===d.modes.BLK){this._handleBLK(a);continue}if(this.mode===d.modes.EXP){this._handleEXP(a);continue}}this._endMode(d.modes.MKP);for(b=0,c=this.blockStack.count();b<c;b++){e=this.blockStack.pop();if(e.type===d.modes.BLK)throw this.exceptionFactory(new Error,"UNMATCHED",e.tok)}this.debug&&(f=this.consumedTokens.sort(function(a,b){return b.touched-a.touched}),console.group("Top 30 tokens ordered by TOUCHING"),f.slice(0,30).forEach(function(a){console.debug(a.touched,a)}),console.groupEnd());return this.buffers},compile:function(a){a=a||{},a.useWith=a.useWith===!0?!0:!1,a.modelName=a.modelName||"model";var b,c,e=null,f=null,g='var out = "", __vtemp = "";\n',h=d.modes,i=/[\"']/gi,j=/[\n\r]/gi,k;for(b=0,c=this.buffers.length;b<c;b++)e=f,f=this.buffers[b],f.type===h.MKP&&(g+="out += '"+f.value.replace(i,'"').replace(j,"\\n")+"';\n"),f.type===h.BLK&&(g+=f.value.replace(i,'"').replace(j,"")+"\n"),f.type===h.EXP&&(g+="__vtemp = (typeof (__vtemp = "+f.value+') === "undefined" ? "" : __vtemp);'+(f.escape===!0?'__vtemp = __vtemp.toString().replace(/&(?!w+;)/g, "&#38;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;")':f.value).replace(i,'"').replace(j,"\\n")+";out += __vtemp;"+"\n");this.debug&&console.debug(g);try{k=new Function(a.modelName,(a.useWith===!0?"with("+a.modelName+" || {}){"+g+"}":g)+"\nreturn out;")}catch(l){l.message+=" :::: GENERATED :::: "+g;throw l}return k},exceptionFactory:function(a,b,c){var d="",e;for(e=0;e<this.buffers.length;e++)d+=this.buffers[e].value;d.length>100&&(d=d.substring(d.length-100));switch(b){case"UNMATCHED":a.name="UnmatchedCharacterError",c&&(a.message="Unmatched "+c.type+' near: "'+d+'"'+" at line "+c.line+", character "+c.chr+". Value: "+c.val,a.lineNumber=c.line);break;case"INVALIDINPUT":a.name="InvalidParserInputError",c&&(this.message="Asked to parse invalid or non-string input: "+c),this.lineNumber=0}return a},_useToken:function(a){this.debug&&this.consumedTokens.push(a),this.buffer+=a.val},_useTokens:function(a){for(var b=0,c=a.length;b<c;b++)this.debug&&this.consumedTokens.push(a[b]),this.buffer+=a[b].val},_advanceUntilNot:function(a){var b,c,d=[];while(c=this.lex.lookahead(1))if(c.type===a)b=this.lex.advance(),d.push(b);else break;return d},_advanceUntilMatched:function(a,b,c){var d=a,e=0,f=0,g=[];while(d){d.type===b&&e++,d.type===c&&f++,g.push(d);if(e===f)break;d=this.lex.advance();if(!d)throw this.exceptionFactory(new Error,"UNMATCHED",a)}return g},_retconMode:function(a){this.mode=a},_endMode:function(a){this.buffer!==""&&(this.buffers.push({type:this.mode,value:this.buffer,escape:this.escape}),this.buffer="",this.escape=!0),this.mode=a||d.modes.MKP},_handleMKP:function(a){var b=this.lex.lookahead(1),c=this.lex.lookahead(2),e=null,f=null,g=[];switch(a.type){case this.tks.AT_STAR_OPEN:this._advanceUntilMatched(a,this.tks.AT_STAR_OPEN,this.tks.AT_STAR_CLOSE);break;case this.tks.AT_BANG:this._endMode(d.modes.EXP),this.escape=!1;break;case this.tks.AT:if(b)switch(b.type){case this.tks.PAREN_OPEN:case this.tks.IDENTIFIER:this._endMode(d.modes.EXP),this.escape=!0;break;case this.tks.KEYWORD:case this.tks.FUNCTION:case this.tks.BRACE_OPEN:this._endMode(d.modes.BLK);break;default:this._useToken(this.lex.advance())}break;case this.tks.BRACE_OPEN:this._endMode(d.modes.BLK),this.lex.defer(a);break;case this.tks.BRACE_CLOSE:this._endMode(d.modes.BLK),this.lex.defer(a);break;case this.tks.TEXT_TAG_OPEN:case this.tks.HTML_TAG_OPEN:f=a.val.match(/^<([^\/ >]+)/i),f===null&&b&&b.type===this.tks.AT&&c&&(f=c.val.match(/(.*)/)),this.blockStack.push({type:d.modes.MKP,tag:f[1],tok:a}),this.tks.HTML_TAG_OPEN===a.type&&this._useToken(a);break;case this.tks.TEXT_TAG_CLOSE:case this.tks.HTML_TAG_CLOSE:f=a.val.match(/^<\/([^>]+)/i),f===null&&b&&b.type===this.tks.AT&&c&&(f=c.val.match(/(.*)/)),e=this.blockStack.pop();while(e!==null){if(e.type===d.modes.MKP&&f[1]===e.tag)break;g.push(e),e=this.blockStack.pop()}if(e===null)throw this.exceptionFactory(new Error,"UNMATCHED",a);this.blockStack.raw().push.apply(this.blockStack.raw(),g),this.tks.HTML_TAG_CLOSE===a.type&&this._useToken(a),e=this.blockStack.peek(),e!==null&&e.type===d.modes.BLK&&(b.type===this.tks.WHITESPACE||b.type===this.tks.NEWLINE)&&(this._useTokens(this._advanceUntilNot(this.tks.WHITESPACE)),this._endMode(d.modes.BLK));break;default:this._useToken(a)}},_handleBLK:function(a){var b=this.lex.lookahead(1),c=null,e=[];switch(a.type){case this.tks.AT:switch(b.type){case this.tks.AT:break;default:this.lex.defer(a),this._endMode(d.modes.MKP)}break;case this.tks.AT_COLON:this._endMode(d.modes.MKP);break;case this.tks.TEXT_TAG_OPEN:case this.tks.TEXT_TAG_CLOSE:case this.tks.HTML_TAG_SELFCLOSE:case this.tks.HTML_TAG_OPEN:case this.tks.HTML_TAG_CLOSE:this._endMode(d.modes.MKP),this.lex.defer(a);break;case this.tks.BRACE_OPEN:case this.tks.PAREN_OPEN:this.blockStack.push({type:d.modes.BLK,tok:a}),this._useToken(a);break;case this.tks.BRACE_CLOSE:case this.tks.PAREN_CLOSE:c=this.blockStack.pop();while(c!==null&&c.type!==d.modes.BLK)e.push(c),c=this.blockStack.pop();this.blockStack.raw().push.apply(this.blockStack.raw(),e);if(c===null||c!==null&&c.type!==d.modes.BLK)throw this.exceptionFactory(new Error,"UNMATCHED",a);this._useToken(a),this._advanceUntilNot(this.tks.WHITESPACE),b=this.lex.lookahead(1);if(b&&(b.type===this.tks.KEYWORD||b.type===this.tks.FUNCTION))break;c=this.blockStack.peek(),c!==null&&c.type===d.modes.MKP&&this._endMode(d.modes.MKP);break;case this.tks.WHITESPACE:this._useToken(a),this._advanceUntilNot(this.tks.WHITESPACE);break;default:this._useToken(a)}},_handleEXP:function(a){var b=null;switch(a.type){case this.tks.KEYWORD:case this.tks.FUNCTION:this._endMode(d.modes.BLK),this.lex.defer(a);break;case this.tks.IDENTIFIER:this._useToken(a);break;case this.tks.HARD_PAREN_OPEN:this._useTokens(this._advanceUntilMatched(a,this.tks.HARD_PAREN_OPEN,this.tks.HARD_PAREN_CLOSE)),b=this.lex.lookahead(1),b&&b.type===this.tks.IDENTIFIER&&this._endMode(d.modes.MKP);break;case this.tks.PAREN_OPEN:b=this.lex.lookahead(1),!b||b.type!==this.tks.KEYWORD&&b.type!==this.tks.FUNCTION?(this._useTokens(this._advanceUntilMatched(a,this.tks.PAREN_OPEN,this.tks.PAREN_CLOSE)),b=this.lex.lookahead(1),b&&b.type===this.tks.IDENTIFIER&&this._endMode(d.modes.MKP)):(this.lex.defer(a),this._retconMode(d.modes.BLK));break;case this.tks.PERIOD:b=this.lex.lookahead(1),!b||b.type!==this.tks.IDENTIFIER&&b.type!==this.tks.KEYWORD&&b.type!==this.tks.FUNCTION?(this._endMode(d.modes.MKP),this.lex.defer(a)):this._useToken(a);break;default:this._endMode(d.modes.MKP),this.lex.defer(a)}}},a.VLexer=b,a.VParser=d,a.compile=function e(b,c){var e=new d(b),f;c=c||{},c.useWith=typeof c.useWith=="undefined"?a.config.useWith:c.useWith,c.modelName=c.modelName||a.config.modelName,e.parse(),f=e.compile(c);return function(a){return f(a)}}})(typeof exports=="undefined"?this.vash={}:exports)